<html>
	<head>
		<title>CrossRef to n-triples</title>
		<meta charset="UTF-8"/>
		<script src="jquery.js"></script>
		<script src="jsonld.js"></script>
		<script src="shared.js"></script>
		<style>
		td { border: 1px solid red; }
		</style>
	</head>
<body>

<h1>CrossRef to n-triples</h1>

<div>
	<div style="width:100%;height:auto;">
		<h2>Mendeley</h2>
		
<!-- {
	"status": "ok",
	"message-type": "work",
	"message-version": "1.0.0",
	"message": {
		"indexed": {
			"date-parts": [
				[2016, 7, 28]
			],
			"date-time": "2016-07-28T04:41:16Z",
			"timestamp": 1469680876192
		},
		"reference-count": 52,
		"publisher": "Elsevier BV",
		"license": [{
			"content-version": "tdm",
			"delay-in-days": 0,
			"start": {
				"date-parts": [
					[2016, 7, 1]
				],
				"date-time": "2016-07-01T00:00:00Z",
				"timestamp": 1467331200000
			},
			"URL": "http:\/\/www.elsevier.com\/tdm\/userlicense\/1.0\/"
		}, {
			"content-version": "vor",
			"delay-in-days": 20,
			"start": {
				"date-parts": [
					[2016, 7, 21]
				],
				"date-time": "2016-07-21T00:00:00Z",
				"timestamp": 1469059200000
			},
			"URL": "http:\/\/creativecommons.org\/licenses\/by\/4.0\/"
		}],
		"funder": [{
			"award": [],
			"doi-asserted-by": "publisher",
			"name": "Rufford Foundation",
			"DOI": "10.13039\/100007463"
		}, {
			"award": ["SFRH\/BPD\/80726\/2011"],
			"name": "FCT - the Foundation for Science and Technology"
		}, {
			"award": ["1329750"],
			"name": "National Science Foundation Dissertation Improvement Grant"
		}, {
			"award": ["308454"],
			"name": "European Union"
		}, {
			"award": [],
			"name": "US Geological Survey Ecosystem"
		}],
		"published-print": {
			"date-parts": [
				[2016, 7]
			]
		},
		"DOI": "10.1016\/j.biocon.2016.07.014",
		"type": "journal-article",
		"created": {
			"date-parts": [
				[2016, 7, 28]
			],
			"date-time": "2016-07-28T03:26:08Z",
			"timestamp": 1469676368000
		},
		"source": "CrossRef",
		"title": ["Global biodiversity monitoring: From data sources to Essential Biodiversity Variables"],
		"prefix": "http:\/\/id.crossref.org\/prefix\/10.1016",
		"author": [{
			"affiliation": [],
			"family": "Proen\u00e7a",
			"given": "V\u00e2nia",
			"ORCID": "http:\/\/orcid.org\/0000-0001-8245-357X"
		}, {
			"affiliation": [],
			"family": "Martin",
			"given": "Laura Jane"
		}, {
			"affiliation": [],
			"family": "Pereira",
			"given": "Henrique Miguel"
		}, {
			"affiliation": [],
			"family": "Fernandez",
			"given": "Miguel"
		}, {
			"affiliation": [],
			"family": "McRae",
			"given": "Louise"
		}, {
			"affiliation": [],
			"family": "Belnap",
			"given": "Jayne"
		}, {
			"affiliation": [],
			"family": "B\u00f6hm",
			"given": "Monika"
		}, {
			"affiliation": [],
			"family": "Brummitt",
			"given": "Neil"
		}, {
			"affiliation": [],
			"family": "Garc\u00eda-Moreno",
			"given": "Jaime"
		}, {
			"affiliation": [],
			"family": "Gregory",
			"given": "Richard D."
		}, {
			"affiliation": [],
			"family": "Honrado",
			"given": "Jo\u00e3o Pradinho"
		}, {
			"affiliation": [],
			"family": "J\u00fcrgens",
			"given": "Norbert"
		}, {
			"affiliation": [],
			"family": "Opige",
			"given": "Michael"
		}, {
			"affiliation": [],
			"family": "Schmeller",
			"given": "Dirk S."
		}, {
			"affiliation": [],
			"family": "Tiago",
			"given": "Patr\u00edcia"
		}, {
			"affiliation": [],
			"family": "van Swaay",
			"given": "Chris A.M."
		}],
		"member": "http:\/\/id.crossref.org\/member\/78",
		"container-title": ["Biological Conservation"],
		"link": [{
			"intended-application": "text-mining",
			"content-version": "vor",
			"content-type": "text\/xml",
			"URL": "http:\/\/api.elsevier.com\/content\/article\/PII:S0006320716302786?httpAccept=text\/xml"
		}, {
			"intended-application": "text-mining",
			"content-version": "vor",
			"content-type": "text\/plain",
			"URL": "http:\/\/api.elsevier.com\/content\/article\/PII:S0006320716302786?httpAccept=text\/plain"
		}],
		"deposited": {
			"date-parts": [
				[2016, 7, 28]
			],
			"date-time": "2016-07-28T03:26:12Z",
			"timestamp": 1469676372000
		},
		"score": 1.0,
		"subtitle": [],
		"issued": {
			"date-parts": [
				[2016, 7]
			]
		},
		"alternative-id": ["S0006320716302786"],
		"URL": "http:\/\/dx.doi.org\/10.1016\/j.biocon.2016.07.014",
		"ISSN": ["0006-3207"],
		"subject": ["Ecology, Evolution, Behavior and Systematics", "Nature and Landscape Conservation"]
	}
}	-->

<!--

			{
    "indexed": {
        "date-parts": [
            [
                2015,
                12,
                25
            ]
        ],
        "date-time": "2015-12-25T23:19:19Z",
        "timestamp": 1451085559768
    },
    "reference-count": 89,
    "publisher": "Wiley-Blackwell",
    "issue": "3",
    "content-domains": {
        "domains": [],
        "crossmark-restriction": false
    },
    "license": [
        {
            "content-version": "tdm",
            "delay-in-days": 337,
            "start": {
                "date-parts": [
                    [
                        2015,
                        9,
                        1
                    ]
                ],
                "date-time": "2015-09-01T00:00:00Z",
                "timestamp": 1441065600000
            },
            "URL": "http://doi.wiley.com/10.1002/tdm_license_1"
        }
    ],
    "funder": [
        {
            "award": [
                "Buck Postdoctoral Fellowship"
            ],
            "doi-asserted-by": "publisher",
            "name": "Smithsonian Institution",
            "DOI": "10.13039/100000014"
        },
        {
            "award": [
                "EF-0431330",
                "DEB-1354739",
                "DEB-1242260",
                "DEB-1354996"
            ],
            "doi-asserted-by": "publisher",
            "name": "National Science Foundation",
            "DOI": "10.13039/100000001"
        },
        {
            "award": [
                "Grand Challenges"
            ],
            "doi-asserted-by": "publisher",
            "name": "National Museum of Natural History",
            "DOI": "10.13039/100006271"
        }
    ],
    "published-print": {
        "date-parts": [
            [
                2015,
                5
            ]
        ]
    },
    "DOI": "10.1111/1755-0998.12328",
    "type": "journal-article",
    "created": {
        "date-parts": [
            [
                2014,
                9,
                10
            ]
        ],
        "date-time": "2014-09-10T13:43:58Z",
        "timestamp": 1410356638000
    },
    "page": "489-501",
    "source": "CrossRef",
    "title": "Target enrichment of ultraconserved elements from arthropods provides a genomic perspective on relationships among Hymenoptera",
    "prefix": "http://id.crossref.org/prefix/10.1111",
    "volume": "15",
    "author": [
        {
            "affiliation": [
                {
                    "name": "Department of Ecology and Evolutionary Biology; University of California; Los Angeles CA 90095 USA"
                },
                {
                    "name": "Department of Biological Sciences; Louisiana State University; Baton Rouge LA 70803 USA"
                }
            ],
            "family": "Faircloth",
            "given": "Brant C."
        },
        {
            "affiliation": [
                {
                    "name": "Department of Entomology; National Museum of Natural History; Smithsonian Institution; Washington DC 20560 USA"
                }
            ],
            "family": "Branstetter",
            "given": "Michael G."
        },
        {
            "affiliation": [
                {
                    "name": "Department of Biology; University of Maryland; College Park MD 20742 USA"
                },
                {
                    "name": "Department of Vertebrate Zoology; National Museum of Natural History; Smithsonian Institution; Washington DC 20560 USA"
                }
            ],
            "family": "White",
            "given": "Noor D."
        },
        {
            "affiliation": [
                {
                    "name": "Department of Entomology; National Museum of Natural History; Smithsonian Institution; Washington DC 20560 USA"
                }
            ],
            "family": "Brady",
            "given": "Seán G."
        }
    ],
    "member": "http://id.crossref.org/member/311",
    "published-online": {
        "date-parts": [
            [
                2014,
                9,
                29
            ]
        ]
    },
    "container-title": "Molecular Ecology Resources",
    "link": [
        {
            "intended-application": "text-mining",
            "content-version": "vor",
            "content-type": "unspecified",
            "URL": "http://api.wiley.com/onlinelibrary/tdm/v1/articles/10.1111%2F1755-0998.12328"
        }
    ],
    "deposited": {
        "date-parts": [
            [
                2015,
                10,
                20
            ]
        ],
        "date-time": "2015-10-20T07:15:29Z",
        "timestamp": 1445325329000
    },
    "score": 1,
    "subtitle": [],
    "issued": {
        "date-parts": [
            [
                2014,
                9,
                29
            ]
        ]
    },
    "URL": "http://dx.doi.org/10.1111/1755-0998.12328",
    "ISSN": [
        "1755-098X"
    ],
    "subject": [
        "Biotechnology",
        "Genetics",
        "Ecology, Evolution, Behavior and Systematics"
    ]
}
-->
		
			<textarea id="json" style="width:100%;background-color:#224FBC;color:#FFFF66;" rows="20">
{
   "_id": "http://dx.doi.org/10.1525/cond.2011.113.4.924",
   "_rev": "1-5acbd828d271a9da9959ae00f0cd6e78",
   "status": "ok",
   "message-type": "work",
   "message-version": "1.0.0",
   "message": {
       "indexed": {
           "date-parts": [
               [
                   2015,
                   12,
                   28
               ]
           ],
           "date-time": "2015-12-28T01:29:08Z",
           "timestamp": 1451266148636
       },
       "reference-count": 0,
       "publisher": "Cooper Ornithological Society",
       "issue": "4",
       "content-domain": {
           "domain": [
           ],
           "crossmark-restriction": false
       },
       "short-container-title": [
       ],
       "published-print": {
           "date-parts": [
               [
                   2011,
                   11
               ]
           ]
       },
       "DOI": "10.1525/cond.2011.113.4.924",
       "type": "journal-article",
       "created": {
           "date-parts": [
               [
                   2011,
                   12,
                   13
               ]
           ],
           "date-time": "2011-12-13T00:19:41Z",
           "timestamp": 1323735581000
       },
       "page": "924-924",
       "source": "CrossRef",
       "title": [
           " Effects of Climate Change on Birds .— Anders Pape Møller , Wolfgang Fieldler , and Peter Berthold , editors. 2010. Oxford University Press, New York. 321 pp. + 9 color plates. ISBN-978-0-19-956975-5. $117.00 (hard cover). "
       ],
       "prefix": "http://id.crossref.org/prefix/10.1650",
       "volume": "113",
       "author": [
           {
               "affiliation": [
               ],
               "family": "Peterson",
               "given": "A. Townsend"
           }
       ],
       "member": "http://id.crossref.org/member/1225",
       "container-title": [
           "The Condor"
       ],
       "original-title": [
       ],
       "deposited": {
           "date-parts": [
               [
                   2014,
                   1,
                   6
               ]
           ],
           "date-time": "2014-01-06T17:09:03Z",
           "timestamp": 1389028143000
       },
       "score": 1,
       "subtitle": [
       ],
       "short-title": [
       ],
       "issued": {
           "date-parts": [
               [
                   2011,
                   11
               ]
           ]
       },
       "alternative-id": [
           "10.1525/cond.2011.113.4.924"
       ],
       "URL": "http://dx.doi.org/10.1525/cond.2011.113.4.924",
       "ISSN": [
           "0010-5422",
           "1938-5129"
       ],
       "subject": [
           "Animal Science and Zoology",
           "Ecology, Evolution, Behavior and Systematics"
       ]
   },
   "message-format": "application/vnd.crossref-api-message+json"
}			
			</textarea>
			<br />
			<button onclick="convert()">Convert</button>
		
	
	</div>
	<div style="clear:both;"></div>
	
	<div style="width:100%;">
		<h2>Triples</h2>
		<div id="output" style="width:100%;color:#222;"></div>
		<div id="jsonld" style="width:100%;white-space:pre;background-color:#333;color:white;"></div>
		<div id="extra" style="width:100%;"></div>

	
	</div>

</div>

		<script>
		
		

		
function message(doc) {
  var triples = [];

  var cluster_id = '';

  var identifiers = [];

  if (doc.message) {

	  // get identifiers
	  for (var i in doc.message) {
		switch (i) {

		  case 'DOI':
			cluster_id = 'http://identifiers.org/doi/' + doc.message[i];

			triples.push(triple(cluster_id,
			  'http://purl.org/dc/terms/identifier',
			  'http://identifiers.org/doi/' + doc.message[i]));
			break;

		  case 'URL':
			if (cluster_id == '') {
			  cluster_id = doc.message[i];
			}

			 triples.push(triple(cluster_id,
			  'http://purl.org/dc/terms/identifier',
			  doc.message[i]));      
			break;
		

			// any alternative ids
		  case 'alternative-id':
			for (var j in doc.message[i]) {
			  triples.push(triple(cluster_id,
				'http://purl.org/dc/terms/identifier',
				doc.message[i][j]));
			}
			break;

		  default:
			break;
		}
	  }


	  // fields
	  for (var i in doc.message) {
		switch (i) {

		  case 'type':
			switch (doc.message[i]) {
			  case 'article-journal':
			  case 'journal-article':
				triples.push(triple(cluster_id,
				  'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',
				  'http://schema.org/ScholarlyArticle'));
				break;
			  default:
				break;
			}
			break;

			// title can be string or array
		  case 'title':
			if (Array.isArray(doc.message[i])) {
			  for (var j in doc.message[i]) {
				triples.push(triple(cluster_id,
				  'http://schema.org/name',
				  doc.message[i][j]));
			  }
			} else {
			  triples.push(triple(cluster_id,
				'http://schema.org/name',
				doc.message[i]));
			}
			 break;
		

			// article metadata
		  case 'issue':
			triples.push(triple(cluster_id,
			  'http://schema.org/issueNumber',
			  doc.message[i]));
			break;

		  case 'pages':
			triples.push(triple(cluster_id,
			  'http://schema.org/pagination',
			  doc.message[i]));
			break;

		  case 'volume':
			triples.push(triple(cluster_id,
			  'http://schema.org/volumeNumber',
			  doc.message[i]));
			break;
		
		  case 'page':
			var parts = doc.message[i].match(/^(.*)\-(.*)$/);
			if (parts) {
			  triples.push(triple(cluster_id,
				'http://schema.org/pageStart',
				parts[1]));
			  triples.push(triple(cluster_id,
				'http://schema.org/pageEnd',
				parts[2]));
			} else {
			  triples.push(triple(cluster_id,
				'http://schema.org/pagination',
				doc.message[i]));
			}
			break;

			// journal
		  case 'ISSN':
			// one journal, but can have 1-2 ISSNs
			// pick one for cluster_id
			 var journal_id = 'http://www.worldcat.org/issn/' + doc.message[i][0];
		 
			  triples.push(triple(cluster_id,
				'http://schema.org/isPartOf',
				journal_id
			  ));
		 
			  // type
			  triples.push(triple(journal_id,
				'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',
				'http://schema.org/Periodical'));

			  // journal name can be string or array
			  if (Array.isArray(doc.message['container-title'])) {
				for (var j in doc.message['container-title']) {
				  triples.push(triple(journal_id,
					'http://schema.org/name',
					doc.message['container-title'][j]));
				}
			  } else {
				triples.push(triple(journal_id,
				  'http://schema.org/name',
				  doc.message['container-title']));
			  }
		  
				// multi?
				if (doc.message['multi']) {
				  if (doc.message['multi']._key['container-title']) {
					for (var j in doc.message['multi']._key['container-title']) {
					  triples.push(triple(journal_id,
						'http://schema.org/name',
						doc.message['multi']._key['container-title'][j], j));  
					}
				  }
				} 
		  
		  
			  // ISSNs
			for (var j in doc.message[i]) {

			  // issn
			  triples.push(triple(journal_id,
				'http://schema.org/issn',
				doc.message[i][j]));
			
			  // identifiers
			triples.push(triple(journal_id,
			  'http://purl.org/dc/terms/identifier',
			  'http://www.worldcat.org/issn/' + doc.message[i][j]));
		  
		  

			}
			break;

			// authors (may include ORCIDs)
			// if no ORCID then we have a bnode, so create an identifier to make this addressable
		  case 'author':
			var n = doc.message[i].length;
			for (var j = 0; j < n; j++) {
			  var author_id = '';

			  // create identifier
			  if (doc.message[i][j].ORCID) {
				author_id = doc.message[i][j].ORCID;
			  } else {
				// #hash identifier 
				author_id = cluster_id + '#author_' + (j + 1);
			  }

			  // type, need to handle organisations as authors
			  triples.push(triple(author_id,
				'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',
				'http://schema.org/Person'));

			  triples.push(triple(cluster_id,
				'http://schema.org/author',
				author_id));

			  // name
			  var name = '';
			  if (doc.message[i][j].given) {
				triples.push(triple(author_id,
				  'http://schema.org/givenName', // ?
				  doc.message[i][j].given));

				name += doc.message[i][j].given;
			  }
			  if (doc.message[i][j].family) {
				triples.push(triple(author_id,
				  'http://schema.org/familyName', // ?
				  doc.message[i][j].family));

				name += ' ' + doc.message[i][j].family;
			  }

			  if (name != '') {
				triples.push(triple(author_id,
				  'http://schema.org/name', // ?
				  name));
			  }
		  
			  // affiliation
			  // make into a role
			 if (doc.message[i][j].affiliation) {     
				var affiliation_count = 1;       
				for (var k in doc.message[i][j].affiliation) {
				   if (doc.message[i][j].affiliation[k].name) {
					 var affiliation_id = author_id + '/affiliation_' + affiliation_count;
					 var affiliation_role_id = author_id + '/affiliation_' + affiliation_count + '/role';
			   
					 // author to role
					 triples.push(triple(author_id,
					  'http://schema.org/affiliation', 
					  affiliation_role_id));
				  
					 triples.push(triple(affiliation_role_id,
					   'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',
						'http://schema.org/OrganizationRole'));
					
					 // role to affiliation
					 triples.push(triple(affiliation_role_id,
					  'http://schema.org/affiliation', 
					  affiliation_id));
				 
					 triples.push(triple(affiliation_id,
					  'http://schema.org/name', 
					  doc.message[i][j].affiliation[k].name));
 
					 triples.push(triple(affiliation_id,
					   'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',
					  'http://schema.org/Organisation'));
 
				   }
				   affiliation_count++;
				 }
			  }
		 

			}
			break;

			// publisher
			// should this be linked to journal rather than article?
		  case 'publisher':
			triples.push(triple(cluster_id,
			  'http://schema.org/publisher',
			  doc.message[i]));
			break;

			// funding
		  case 'funder':
			var n = doc.message[i].length;
			for (var j = 0; j < n; j++) {
			  var funder_id = '';

			  // create identifier for funder
			  if (doc.message[i][j].DOI) {
				funder_id = 'http://identifiers.org/doi/' + doc.message[i][j].DOI;
			  } else {
				// #hash identifier 
				funder_id = cluster_id + '#funder_' + (j + 1);
			  }

			  // create funder 
			  triples.push(triple(funder_id,
				'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',
				'http://schema.org/Organisation'));

			  triples.push(triple(funder_id,
				'http://schema.org/name',
				doc.message[i][j].name));

			  // role
			  var m = doc.message[i][j].award.length;

			  if (m == 0) {
				// funder but award not known
				var award_id = funder_id + '/award';

				triples.push(triple(award_id,
				  'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',
				  'http://schema.org/Role'));

				// link to funder 
				triples.push(triple(award_id,
				  'http://schema.org/funder',
				  funder_id));

				// link role to work         
				triples.push(triple(cluster_id,
				  'http://schema.org/funder',
				  award_id));
			  } else {
				// we have one or more awards
				for (var a = 0; a < m; a++) {
				  var award_id = funder_id + '/award_' + (a+1);

				  triples.push(triple(award_id,
					'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',
					'http://schema.org/Role'));

				  triples.push(triple(award_id,
					'http://schema.org/roleName',
					doc.message[i][j].award[a]
				  ));

				  // link to funder 
				  triples.push(triple(award_id,
					'http://schema.org/funder',
					funder_id));

				  // link role to work         
				  triples.push(triple(cluster_id,
					'http://schema.org/funder',
					award_id));
				}
			  }
			}
			break;

			// license
		  case 'license':
			for (var j in doc.message[i]) {
			  if (doc.message[i][j].URL) {
				triples.push(triple(cluster_id,
				  'http://schema.org/license',
				  doc.message[i][j].URL));
			  }
			}
			break;

			// links to representions such as PDFs, XML, HTML, etc.
			// may be links to text mining sources
		  case 'link':
			var n = doc.message[i].length;
			for (var j = 0; j < n; j++) {
			  var link_id = cluster_id + '#link_' + (j + 1);

			  // type
			  triples.push(triple(link_id,
				'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',
				'http://schema.org/CreativeWork'));

			  if (doc.message[i][j].URL) {
				triples.push(triple(link_id,
				  'http://schema.org/url',
				  doc.message[i][j].URL));

				if (doc.message[i][j]['content-type']) {
				  triples.push(triple(link_id,
					'http://schema.org/fileFormat',
					doc.message[i][j]['content-type']));
				}

				// link to work
				triples.push(triple(cluster_id,
				  'http://schema.org/workExample',
				  link_id));
			  }
			}
			break;

			// tags
		  case 'subject':
			for (var j in doc.message[i]) {
			  triples.push(triple(cluster_id,
				'http://schema.org/about',
				doc.message[i][j]));
			}
			break;
		
			// abstract
		  case 'abstract':
			triples.push(triple(cluster_id,
				  'http://schema.org/description',
				  doc.message[i]));
			break;
		
		  // work level multi
		  // do this because there may be fields that only exist in multi keys
		  case 'multi':
			for (var j in doc.message['multi']._key) {
			  for (var k in doc.message['multi']._key[j]) {
				switch (j) {
				  case 'title':
					triples.push(triple(cluster_id,
						'http://schema.org/name',
						doc.message['multi']._key[j][k], k));
					break;
				  case 'abstract':
					triples.push(triple(cluster_id,
						'http://schema.org/description',
						doc.message['multi']._key[j][k], k));
					break;
				   default:
					 break;
				  }
				}
			}               
			break; 
		

		  default:
			break;
		}
	  }
  }

  // defaults
  triples.push(triple(cluster_id,
    'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',
    'http://schema.org/CreativeWork'));

  output(doc, triples);

}
		
			function convert() {
				var jsonld = $('#json').val();
				var doc = JSON.parse(jsonld);
				message(doc);
				
			
			}
		</script>


</body>
</html>